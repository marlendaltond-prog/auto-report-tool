# 自动化报表工具 - AutoReport Pro 使用说明书（优化版）

## 1. 工具介绍

AutoReport Pro 是一款功能强大的自动化报表生成工具，支持多种数据源、多种输出格式和灵活的数据处理能力。

### 主要功能特点：
- 📊 支持多种数据源：Excel、CSV、SQL数据库、API
- 📄 支持多种输出格式：Excel、PDF、HTML、邮件
- 🔧 可配置的数据处理：过滤、计算、图表生成
- 🎨 可配置的报表样式和模板
- ⏰ 支持定时执行和邮件发送
- 📧 支持报表自动发送到指定邮箱

## 2. 安装要求

### 系统要求：
- Windows/macOS/Linux
- Python 3.7 或更高版本

### 依赖包安装：

工具需要以下第三方依赖包：

```bash
pip install pandas openpyxl sqlalchemy jinja2 reportlab requests
```

或者使用提供的 `requirements.txt` 文件：

```bash
pip install -r requirements.txt
```

## 3. 快速开始

### 3.1 使用命令行参数生成报表

最基础的使用方式是直接通过命令行参数指定数据源和输出格式：

```bash
python auto_report.py --data "302594156_按序号_大学生对新能源汽车购买意向调查研究_254_246.xlsx" --output reports --format excel,pdf
```

**参数详解：**
- `--data`：指定数据源文件路径（支持Excel、CSV格式）
- `--output`：设置报表输出目录
- `--format`：指定输出格式，多个格式用逗号分隔

### 3.2 使用配置文件生成报表

对于更复杂的需求，可以使用JSON配置文件：

```bash
python auto_report.py --config report_config.json
```

## 4. 核心功能模块详解

### 4.1 配置管理

配置管理是工具的基础，负责加载和管理所有配置参数：

**代码示例：**
```python
# 创建配置管理器实例
config_manager = ConfigManager(config_file="report_config.json")

# 获取配置参数
output_dir = config_manager.get("output_dir", "reports")
smtp_server = config_manager.get("email.smtp_server")

# 修改配置
config_manager.config["output_dir"] = "new_reports"
```

**环境变量支持：**
- `REPORT_SMTP_SERVER`：SMTP服务器地址
- `REPORT_SMTP_PORT`：SMTP服务器端口
- `REPORT_EMAIL_USERNAME`：邮箱用户名
- `REPORT_EMAIL_PASSWORD`：邮箱密码
- `REPORT_OUTPUT_DIR`：报表输出目录

### 4.2 数据源模块

工具支持四种数据源类型，每种都有对应的实现类：

#### Excel数据源

**代码示例：**
```python
from auto_report import ExcelDataSource, ReportConfig

# 创建报表配置
config = ReportConfig(
    report_name="新能源汽车购买意向分析",
    data_source_type="excel",
    data_source_path="302594156_按序号_大学生对新能源汽车购买意向调查研究_254_246.xlsx",
    output_format=["excel", "pdf"]
)

# 加载Excel数据
data_source = ExcelDataSource()
df = data_source.load_data(config)

# 验证数据
if data_source.validate_data(df):
    print(f"成功加载{len(df)}行数据")
```

**高级参数：**
```json
{
  "data_source_type": "excel",
  "data_source_path": "data.xlsx",
  "parameters": {
    "sheet_name": "Sheet1",    # 指定工作表
    "header_row": 0,           # 指定表头行
    "usecols": "A:E",         # 指定列范围
    "skiprows": 10,            # 跳过行数
    "nrows": 1000              # 读取行数
  }
}
```

#### CSV数据源

**代码示例：**
```python
from auto_report import CSVDataSource, ReportConfig

config = ReportConfig(
    report_name="销售数据报告",
    data_source_type="csv",
    data_source_path="sales_data.csv",
    output_format=["excel"]
)

# 加载CSV数据
data_source = CSVDataSource()
df = data_source.load_data(config)
```

**高级参数：**
```json
{
  "data_source_type": "csv",
  "data_source_path": "data.csv",
  "parameters": {
    "delimiter": ",",        # 分隔符
    "encoding": "utf-8",     # 编码
    "header": 0,              # 表头行
    "skiprows": 2,            # 跳过行数
    "quoting": 0              # 引用方式
  }
}
```

#### SQL数据源

**代码示例：**
```python
from auto_report import SQLDataSource, ReportConfig

config = ReportConfig(
    report_name="数据库报表",
    data_source_type="sql",
    data_source_path="sqlite:///sales.db",
    output_format=["excel"],
    parameters={
        "query": "SELECT * FROM sales WHERE date >= '2023-01-01'",
        "username": "admin",
        "password": "password"
    }
)

# 加载SQL数据
data_source = SQLDataSource()
df = data_source.load_data(config)
```

**支持的数据库：**
- SQLite
- MySQL
- PostgreSQL
- SQL Server
- Oracle

**连接字符串格式：**
```
# SQLite
sqlite:///database.db

# MySQL
mysql+pymysql://username:password@host:port/database

# PostgreSQL
postgresql://username:password@host:port/database
```

#### API数据源

**代码示例：**
```python
from auto_report import APIDataSource, ReportConfig

config = ReportConfig(
    report_name="API数据报告",
    data_source_type="api",
    data_source_path="https://api.example.com/data",
    output_format=["excel"],
    parameters={
        "method": "GET",
        "headers": {
            "Authorization": "Bearer token123"
        },
        "params": {
            "start_date": "2023-01-01",
            "end_date": "2023-12-31"
        }
    }
)

# 加载API数据
data_source = APIDataSource()
df = data_source.load_data(config)
```

### 4.3 数据处理模块

数据处理模块负责对加载的数据进行过滤、计算和转换：

#### 数据过滤

**代码示例：**
```python
from auto_report import DataProcessor

# 应用过滤条件
filters = {
    "age": {
        "operator": ">=",
        "value": 18
    },
    "gender": {
        "operator": "in",
        "value": ["男", "女"]
    }
}

filtered_df = DataProcessor.apply_filters(original_df, filters)
```

**支持的操作符：**
- `==`, `!=`：等于、不等于
- `>`, `<`, `>=`, `<=`：大于、小于、大于等于、小于等于
- `in`：包含在列表中
- `not_in`：不包含在列表中
- `contains`：包含指定字符串
- `not_contains`：不包含指定字符串

#### 数据计算

**代码示例：**
```python
from auto_report import DataProcessor

# 应用计算
calculations = [
    {
        "name": "total_score",
        "type": "sum",
        "column": "score"
    },
    {
        "name": "avg_score",
        "type": "mean",
        "column": "score"
    },
    {
        "name": "custom_calc",
        "type": "custom",
        "formula": "age * income"
    }
]

processed_df = DataProcessor.apply_calculations(df, calculations)
```

**支持的计算类型：**
- `sum`：求和
- `mean`：平均值
- `median`：中位数
- `min`：最小值
- `max`：最大值
- `count`：计数
- `custom`：自定义公式

### 4.4 报表生成模块

#### Excel报表生成

**代码示例：**
```python
from auto_report import ExcelReportGenerator, DataProcessor

# 创建报表生成器
excel_generator = ExcelReportGenerator(style_template="modern")

# 应用计算和过滤
calculations = [{
    "name": "total_count",
    "type": "count",
    "column": "序号"
}]

processed_df = DataProcessor.apply_calculations(df, calculations)
metrics = DataProcessor.calculate_metrics(processed_df)

# 生成Excel报表
excel_file = excel_generator.generate(processed_df, metrics, "report.xlsx")
```

**图表生成示例：**
```python
# 配置图表
charts = [
    {
        "type": "bar",
        "title": "性别分布",
        "x_axis": "性别",
        "y_axis": "计数",
        "position": "A10:E25"
    },
    {
        "type": "pie",
        "title": "购买意向比例",
        "labels": "购买意向",
        "values": "计数",
        "position": "F10:J25"
    }
]

# 添加图表到Excel报表
excel_generator._add_charts(workbook, processed_df, charts)
```

**支持的图表类型：**
- `bar`：柱状图
- `line`：折线图
- `pie`：饼图
- `scatter`：散点图

#### PDF报表生成

**代码示例：**
```python
from auto_report import PDFReportGenerator, DataProcessor

# 创建PDF报表生成器
pdf_generator = PDFReportGenerator()

# 生成PDF报表
pdf_file = pdf_generator.generate(processed_df, metrics, "report.pdf")
```

**PDF配置参数：**
```json
{
  "parameters": {
    "pdf": {
      "page_size": "A4",           # 页面大小
      "orientation": "portrait",   # 页面方向
      "include_charts": true       # 是否包含图表
    }
  }
}
```

#### HTML报表生成

**代码示例：**
```python
from auto_report import HTMLReportGenerator, DataProcessor

# 使用默认模板生成HTML
html_generator = HTMLReportGenerator()
html_file = html_generator.generate(processed_df, metrics, "report.html")

# 使用自定义模板
html_generator_custom = HTMLReportGenerator(template_path="custom_template.html")
html_file_custom = html_generator_custom.generate(processed_df, metrics, "report_custom.html")
```

### 4.5 邮件发送功能

**代码示例：**
```python
from auto_report import EmailSender

# 创建邮件发送器
email_sender = EmailSender(
    smtp_server="smtp.example.com",
    smtp_port=587,
    username="report_sender@example.com",
    password="email_password"
)

# 发送报表
email_sender.send_report(
    report_paths=["report.xlsx", "report.pdf"],
    recipients=["user1@example.com", "user2@example.com"],
    subject="新能源汽车购买意向分析报表",
    body="尊敬的用户，\n\n请查收本月销售报表。\n\n此致\n自动化报表系统"
)
```

## 5. 自动化报表引擎

AutoReportEngine是工具的核心类，整合了所有功能模块：

**代码示例：**
```python
from auto_report import AutoReportEngine, ReportConfig

# 创建报表配置
config = ReportConfig(
    report_name="新能源汽车购买意向分析",
    data_source_type="excel",
    data_source_path="302594156_按序号_大学生对新能源汽车购买意向调查研究_254_246.xlsx",
    output_format=["excel", "pdf"],
    recipients=["admin@example.com"],
    filters={
        "年级": {
            "operator": "in",
            "value": ["大一", "大二", "大三", "大四"]
        }
    },
    calculations=[
        {
            "name": "total_respondents",
            "type": "count",
            "column": "序号"
        }
    ],
    charts=[
        {
            "type": "bar",
            "title": "年级分布",
            "x_axis": "年级",
            "y_axis": "total_respondents",
            "position": "A10:E25"
        }
    ],
    parameters={
        "excel": {
            "style_template": "modern",
            "auto_adjust_columns": true
        },
        "pdf": {
            "page_size": "A4"
        }
    }
)

# 创建并运行引擎
engine = AutoReportEngine(config)
generated_files = engine.run()

print("生成的报表：")
for format, path in generated_files.items():
    print(f"{format}: {path}")
```

## 6. 完整配置文件示例

```json
{
  "report_name": "大学生新能源汽车购买意向分析",
  "data_source_type": "excel",
  "data_source_path": "302594156_按序号_大学生对新能源汽车购买意向调查研究_254_246.xlsx",
  "output_dir": "reports",
  "output_format": ["excel", "pdf", "html"],
  "schedule": "0 8 * * 1-5",
  "recipients": ["admin@example.com", "research@example.com"],
  "filters": {
    "年级": {
      "operator": "in",
      "value": ["大一", "大二", "大三", "大四"]
    },
    "性别": {
      "operator": "in",
      "value": ["男", "女"]
    }
  },
  "calculations": [
    {
      "name": "总样本数",
      "type": "count",
      "column": "序号"
    },
    {
      "name": "平均年龄",
      "type": "mean",
      "column": "年龄"
    }
  ],
  "charts": [
    {
      "type": "bar",
      "title": "年级分布",
      "x_axis": "年级",
      "y_axis": "总样本数",
      "position": "A10:E25"
    },
    {
      "type": "pie",
      "title": "性别占比",
      "labels": "性别",
      "values": "计数",
      "position": "F10:J25"
    },
    {
      "type": "line",
      "title": "购买意向趋势",
      "x_axis": "年龄",
      "y_axis": "购买意向",
      "position": "A30:E45"
    }
  ],
  "parameters": {
    "excel": {
      "style_template": "modern",
      "auto_adjust_columns": true,
      "include_charts": true
    },
    "pdf": {
      "page_size": "A4",
      "orientation": "portrait"
    },
    "html": {
      "template_path": "templates/report_template.html",
      "css_path": "templates/style.css"
    },
    "email": {
      "subject": "【自动报表】大学生新能源汽车购买意向分析",
      "body": "尊敬的用户，\n\n请查收最新的大学生新能源汽车购买意向分析报告。\n\n此致\n自动化报表系统",
      "smtp_server": "smtp.example.com",
      "smtp_port": 587,
      "username": "report_sender@example.com",
      "password": "email_password"
    }
  }
}
```

## 7. 高级功能

### 7.1 定时执行

工具支持使用cron表达式配置定时执行：

**代码示例：**
```python
from auto_report import AutoReportEngine, ReportConfig

config = ReportConfig(
    # ... 其他配置
    schedule="0 8 * * 1-5"  # 每周一至周五早上8点执行
)

engine = AutoReportEngine(config)
engine.run()
```

**常见cron表达式：**
- `0 0 * * *`：每天午夜执行
- `0 8 * * 1-5`：每周一至周五早上8点执行
- `0 0 1 * *`：每月1日0点执行
- `0 0 1 1 *`：每年1月1日执行

### 7.2 自定义数据处理

对于复杂的数据处理需求，可以扩展DataProcessor类：

**代码示例：**
```python
from auto_report import DataProcessor

class CustomDataProcessor(DataProcessor):
    @staticmethod
    def custom_processing(df):
        # 自定义处理逻辑
        df['new_column'] = df['column1'] + df['column2']
        return df

# 使用自定义处理器
processed_df = CustomDataProcessor.custom_processing(df)
```

### 7.3 报表模板定制

**Excel模板定制：**
```python
from auto_report import ExcelReportGenerator

class CustomExcelGenerator(ExcelReportGenerator):
    def _apply_custom_styles(self, worksheet, df):
        # 应用自定义样式
        header_font = Font(name='Arial', size=12, bold=True)
        header_fill = PatternFill(start_color="0000FF", end_color="0000FF", fill_type="solid")
        
        for col in range(df.shape[1]):
            cell = worksheet.cell(row=1, column=col+1)
            cell.font = header_font
            cell.fill = header_fill

# 使用自定义生成器
generator = CustomExcelGenerator()
generator.generate(df, metrics, "custom_report.xlsx")
```

## 8. 最佳实践

### 8.1 性能优化

**大数据集处理：**
1. 使用SQL数据源直接查询所需数据
2. 在配置中设置适当的过滤条件减少数据量
3. 关闭不必要的图表生成
4. 使用分页或分批次处理

```json
{
  "filters": {
    "date": {
      "operator": ">=",
      "value": "2023-01-01"
    }
  },
  "parameters": {
    "excel": {
      "include_charts": false
    }
  }
}
```

### 8.2 错误处理

**代码示例：**
```python
try:
    from auto_report import AutoReportEngine, ReportConfig
    
    config = ReportConfig(
        report_name="测试报告",
        data_source_type="excel",
        data_source_path="nonexistent.xlsx",
        output_format=["excel"]
    )
    
    engine = AutoReportEngine(config)
    generated_files = engine.run()
    
except FileNotFoundError:
    print("错误：数据源文件不存在")
except ImportError as e:
    print(f"错误：缺少依赖包：{e}")
except Exception as e:
    print(f"错误：生成报表失败：{e}")
```

## 9. 常见问题解答

### Q1: 工具启动时提示缺少依赖包怎么办？
A: 请按照提示安装所需的依赖包：
```bash
pip install pandas openpyxl sqlalchemy jinja2 reportlab requests
```

### Q2: 如何生成多个格式的报表？
A: 使用 `--format` 参数，多个格式用逗号分隔：
```bash
python auto_report.py --format excel,pdf,html
```

### Q3: 如何处理Excel中的多个工作表？
A: 在配置文件中指定工作表名称：
```json
{
  "parameters": {
    "sheet_name": "Sheet2"
  }
}
```

### Q4: 如何解决中文乱码问题？
A: 确保所有文件使用UTF-8编码，并在CSV配置中指定编码：
```json
{
  "parameters": {
    "encoding": "utf-8"
  }
}
```

### Q5: 如何自定义报表样式？
A: 扩展对应的报表生成器类，重写样式应用方法：
```python
class CustomExcelGenerator(ExcelReportGenerator):
    def _apply_excel_styles(self, worksheet, df):
        # 自定义样式逻辑
        pass
```

## 10. 实际应用案例

### 案例：大学生新能源汽车购买意向分析

**数据源：**
- 文件名：`302594156_按序号_大学生对新能源汽车购买意向调查研究_254_246.xlsx`
- 数据量：254行有效数据
- 包含字段：序号、年级、性别、年龄、专业、购买意向等

**使用命令：**
```bash
python auto_report.py --data "302594156_按序号_大学生对新能源汽车购买意向调查研究_254_246.xlsx" --output "新能源汽车购买意向分析" --format excel,pdf,html
```

**生成结果：**
- Excel报表：包含完整数据、统计分析和图表
- PDF报表：适合打印和分发的格式
- HTML报表：可在浏览器中查看的交互式报表

## 11. 技术支持

如果您在使用过程中遇到问题或有功能建议，请通过以下方式联系：

- 邮箱：support@autoreport.com
- 官方文档：https://autoreport.example.com/docs
- GitHub：https://github.com/autoreport/pro

---

**AutoReport Pro** - 让报表生成更简单、更高效！